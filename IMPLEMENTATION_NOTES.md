# Implementation Notes

## Standard Compliance Status

This document describes the compliance status of `libvrf-js` with respect to cryptographic standards and compatibility with the original C++ `libvrf` implementation.

### ⚠️ Important: EC VRF RFC 9381 Compliance

**Current Status: NOT RFC 9381 Compliant**

The EC VRF implementation (`EC_VRF_P256_SHA256_TAI`) uses a **simplified deterministic construction** and does **NOT** implement the full RFC 9381 specification. Specifically:

#### What's Missing:
- Hash-to-curve operations as specified in RFC 9381
- Proper elliptic curve point multiplication
- RFC 9381 compliant Gamma, c, s components in the proof
- Full EC VRF verification using elliptic curve operations

#### What We Do Instead:
- Deterministic HMAC-like construction using Node.js `crypto.createECDH`
- Proof generation using deterministic hash expansion
- Simplified verification that checks proof structure and binding

#### Implications:
1. **NOT interoperable** with RFC 9381 compliant implementations (including the C++ libvrf)
2. **Different proof format** - proofs generated by this library cannot be verified by RFC 9381 compliant verifiers
3. **Different VRF outputs** - the VRF values will differ from RFC 9381 implementations
4. **Self-consistent** - proofs generated by this library can be verified by this library

#### Why This Limitation Exists:
Implementing full RFC 9381 compliance requires:
- Complex elliptic curve operations (hash-to-curve, scalar multiplication)
- Libraries like `@noble/curves` which had ESM/CommonJS compatibility issues with Jest
- Significantly more complex code

The current implementation provides VRF functionality that is:
- ✅ Deterministic
- ✅ Cryptographically sound (based on HMAC-like construction)
- ✅ Self-consistent (prove/verify cycle works)
- ❌ NOT RFC 9381 compliant
- ❌ NOT interoperable with standard EC VRF implementations

### RSA VRF Implementations

#### RSA-FDH VRF
**Status: Functionally Compatible**

- Implements Full Domain Hash using MGF1 mask generation
- Uses suite strings matching the C++ version
- Should produce compatible proofs for basic use cases
- ⚠️ Not tested against C++ test vectors

Implementation details:
- Uses `node-rsa` for key operations
- Custom `modPow` for RSA operations
- MGF1 with suite string salt for domain expansion

#### RSA-PSS-NOSALT VRF
**Status: Functionally Compatible**

- Implements PSS encoding without salt (saltLength = 0)
- Uses MGF1 for mask generation
- Follows PKCS#1 PSS structure with modifications for VRF
- ⚠️ Not tested against C++ test vectors

Implementation details:
- PSS encoding: `EM = maskedDB || H || 0xbc`
- DB structure: `DB = PS || 0x01 || salt` (where salt is empty)
- MGF1 mask generation following RFC 8017

### Test Vector Compliance

**Current Status: No Standard Test Vectors**

The C++ `libvrf` includes RFC 9381 test vectors for EC VRF:
- Test vectors are in `tests/ec_test_vectors.h`
- Test vectors are in `tests/rsa_test_vectors.h`

This JavaScript port does **NOT** include these test vectors and has not been tested for compatibility.

### Interoperability

#### With C++ libvrf:
- **EC VRF**: ❌ NOT compatible (different algorithms)
- **RSA-FDH VRF**: ⚠️ Likely compatible but untested
- **RSA-PSS-NOSALT VRF**: ⚠️ Likely compatible but untested

#### With RFC 9381 Implementations:
- **EC VRF**: ❌ NOT compatible
- **RSA VRFs**: ⚠️ Depends on implementation details

### Recommendations

For **production use** requiring:

1. **RFC 9381 Compliance**: Use the original C++ `libvrf` or another RFC 9381 compliant implementation
2. **Interoperability**: Do NOT use this library's EC VRF with other implementations
3. **Self-contained VRF**: This library works well for systems where all components use `libvrf-js`

### Future Work

To achieve full RFC 9381 compliance for EC VRF, the following would be needed:

1. Integrate a proper elliptic curve library (`@noble/curves` or similar)
2. Implement hash-to-curve as per RFC 9381 Section 5.4.1.2
3. Implement ECVRF_prove with proper Gamma, c, s generation
4. Implement ECVRF_verify with elliptic curve verification
5. Add RFC 9381 test vectors
6. Verify compatibility with C++ libvrf

Estimated effort: Significant (several days of development + testing)

### API Compatibility

Despite the underlying implementation differences, the **API is fully compatible** with the C++ version:
- Same VRF type enumerations
- Same function signatures (adapted to JavaScript/TypeScript)
- Same serialization formats for keys (DER-encoded SPKI)
- Same basic prove/verify workflow

This means code can be ported between C++ and JavaScript versions with minimal changes, even though the EC VRF proofs themselves are not compatible.

---

*Last updated: 2024-11-17*

